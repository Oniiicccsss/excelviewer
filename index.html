<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Excel Data Preview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap4.min.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .drag-drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .drag-drop-area:hover {
            background-color: #f8f9fa;
        }
        .drag-drop-area.dragover {
            background-color: #e9ecef;
            border-color: #007bff;
        }
        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body class="bg-light p-4">

<div class="container">
    <h2 class="mb-4 text-center">Upload & Preview Data</h2>

    <div class="card p-4 mb-4 shadow-sm">
        <h5 class="card-title">Upload Excel/CSV File</h5>
        <div class="drag-drop-area" id="drop-zone">
            <p class="mb-0 text-muted">Drag & drop your file here, or click to browse.</p>
            <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="d-none">
        </div>
        <small class="text-muted mt-2 text-center" id="file-info-text">Supported formats: .xlsx, .xls, .csv</small>
        
        <div class="mt-3" id="feedback-message"></div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header card-header-custom">
            <h5 class="mb-0">Data Preview</h5>
            <small class="text-muted" id="preview-file-name"></small>
        </div>
        <div class="card-body">
            <div id="loading-spinner" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Parsing file...</p>
            </div>
            
            <div class="table-responsive d-none" id="preview-container">
                <table id="previewTable" class="table table-bordered table-striped" style="width:100%">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap4.min.js"></script>
<script>
    let dataTable = null;
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    const loadingSpinner = document.getElementById('loading-spinner');
    const previewContainer = document.getElementById('preview-container');
    const feedbackMessage = document.getElementById('feedback-message');
    const previewFileName = document.getElementById('preview-file-name');

    // Handle drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click(), false);
    fileInput.addEventListener('change', handleFile);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function handleDrop(e) {
        const files = e.dataTransfer.files;
        handleFiles(files);
    }

    function handleFile(e) {
        const files = e.target.files;
        handleFiles(files);
    }

    async function handleFiles(files) {
        const file = files[0];
        if (!file) return;

        // Check file type
        const okExt = /\.(xlsx|xls|csv)$/i.test(file.name);
        if (!okExt) {
            showFeedback('Please upload an Excel or CSV file.', 'danger');
            return;
        }

        showLoading();
        showFeedback(`File selected: ${file.name}`, 'info');

        try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { type: 'array' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const parsedRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

            if (parsedRows.length > 0) {
                renderDataTable(parsedRows, file.name);
                showFeedback('File parsed successfully.', 'success');
            } else {
                showFeedback('The uploaded file is empty or could not be parsed.', 'warning');
                hidePreview();
            }
        } catch (error) {
            console.error(error);
            showFeedback('An error occurred while parsing the file. Please check its format.', 'danger');
            hidePreview();
        } finally {
            hideLoading();
        }
    }

    function showLoading() {
        loadingSpinner.classList.remove('d-none');
        previewContainer.classList.add('d-none');
    }

    function hideLoading() {
        loadingSpinner.classList.add('d-none');
    }

    function hidePreview() {
        if (dataTable) {
            dataTable.destroy();
        }
        $('#previewTable thead').empty();
        $('#previewTable tbody').empty();
        previewContainer.classList.add('d-none');
        previewFileName.textContent = '';
    }

    function showFeedback(message, type) {
        feedbackMessage.innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${message}</div>`;
    }

    function renderDataTable(rows, fileName) {
        if (!rows.length) {
            hidePreview();
            return;
        }
        
        // DataTables works best with a consistent data structure
        const cols = Object.keys(rows[0]).map(c => ({ title: c }));
        const data = rows.map(row => Object.values(row));

        // Destroy previous instance to re-initialize
        if (dataTable) {
            dataTable.destroy();
        }

        // Initialize DataTable with the new data
        dataTable = $('#previewTable').DataTable({
            data: data,
            columns: cols,
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50, 100],
        });
        
        previewFileName.textContent = `File: ${fileName}`;
        previewContainer.classList.remove('d-none');
    }
</script>

</body>
</html>
